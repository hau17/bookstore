<div class="container mt-5">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-receipt"></i> Chi tiết đơn hàng #{{order.order_id}}
      </h5>
    </div>
    <div class="card-body">
      <!-- Order Header Info -->
      <div class="row mb-4">
        <div class="col-md-6">
          <h6 class="text-muted">Thông tin đơn hàng</h6>
          <table class="table table-sm table-borderless">
            <tr>
              <td><strong>Mã đơn hàng:</strong></td>
              <td>#{{order.order_id}}</td>
            </tr>
            <tr>
              <td><strong>Ngày đặt:</strong></td>
              <td>{{formatDate order.created_at}}</td>
            </tr>
            <tr>
              <td><strong>Trạng thái:</strong></td>
              <td>
                <span class="badge bg-{{statusBadge order.status_id}}">
                  {{order.status_name}}
                </span>
              </td>
            </tr>
            <tr>
              <td><strong>Phương thức thanh toán:</strong></td>
              <td>{{order.payment_method}}</td>
            </tr>
            <tr>
              <td><strong>Trạng thái thanh toán:</strong></td>
              <td>
                <span class="badge {{#if (eq order.payment_status 1)}}bg-success{{else}}bg-warning{{/if}}">
                  {{#if (eq order.payment_status 1)}}Đã thanh toán{{else}}Chưa thanh toán{{/if}}
                </span>
              </td>
            </tr>
          </table>
        </div>

        <div class="col-md-6">
          <h6 class="text-muted">Địa chỉ giao hàng</h6>
          <p class="mb-0">{{order.address}}</p>
        </div>
      </div>

      <hr />

      <!-- Order Items -->
      <h6 class="text-muted mb-3">Chi tiết sản phẩm</h6>
      <div class="table-responsive mb-4">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Sản phẩm</th>
              <th>Số lượng</th>
              <th>Đơn giá</th>
              <th>Thành tiền</th>
            </tr>
          </thead>
          <tbody>
            {{#each items}}
              <tr>
                <td>
                  <strong>{{book_title}}</strong>
                  {{#if book_id}}
                    <br />
                    <small class="text-muted">Mã sách: #{{book_id}}</small>
                  {{/if}}
                </td>
                <td>{{quantity}}</td>
                <td>{{formatPrice price}}đ</td>
                <td>
                  <strong class="text-danger">
                    {{formatPrice (mul quantity price)}}đ
                  </strong>
                </td>
              </tr>
            {{/each}}
          </tbody>
        </table>
      </div>

      <!-- Order Total -->
      <div class="row justify-content-end mb-4">
        <div class="col-md-4">
          <table class="table table-sm">
            <tr>
              <td><strong>Tổng cộng:</strong></td>
              <td class="text-end"><strong class="text-danger fs-5">{{formatPrice order.total_amount}}đ</strong></td>
            </tr>
          </table>
        </div>
      </div>

      <hr />

      <!-- Status Timeline -->
      <h6 class="text-muted mb-3">Lịch sử trạng thái</h6>
      <div class="timeline">
        {{#each history}}
          <div class="timeline-item mb-3 pb-3 {{#if @last}}{{else}}border-bottom{{/if}}">
            <div class="d-flex">
              <div class="flex-shrink-0">
                <span class="badge bg-primary">
                  <i class="bi bi-clock"></i>
                </span>
              </div>
              <div class="flex-grow-1 ms-3">
                <h6 class="mb-1">{{status_name}}</h6>
                <small class="text-muted">{{formatDateTime updated_at}}</small>
              </div>
            </div>
          </div>
        {{/each}}
      </div>

      <hr />

      <!-- Action Buttons -->
      <div class="d-flex gap-2">
        {{#if (eq order.status_id 1)}}
          <button type="button" class="btn btn-danger" id="cancelOrderBtn">
            <i class="bi bi-trash"></i> Hủy đơn hàng
          </button>
        {{/if}}
        <a href="/account/orders" class="btn btn-secondary">
          <i class="bi bi-arrow-left"></i> Quay lại
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Xác nhận hủy đơn hàng</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Bạn chắc chắn muốn hủy đơn hàng <strong>#{{order.order_id}}</strong> này không?</p>
        <p class="text-muted small">Lưu ý: Đơn hàng sẽ không thể khôi phục sau khi hủy.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
        <button type="button" class="btn btn-danger" id="confirmCancelBtn">Hủy đơn hàng</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const orderId = {{order.order_id}};
    const cancelModal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));
    const cancelBtn = document.getElementById('cancelOrderBtn');
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');

    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() {
        cancelModal.show();
      });
    }

    if (confirmCancelBtn) {
      confirmCancelBtn.addEventListener('click', async function() {
        try {
          const response = await fetch(`/account/orders/${orderId}/cancel`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const data = await response.json();
            alert(data.message || 'Hủy đơn hàng thành công!');
            window.location.href = '/account/orders';
          } else {
            const error = await response.json();
            alert(error.error || 'Hủy đơn hàng thất bại!');
          }
        } catch (err) {
          console.error('Error:', err);
          alert('Có lỗi xảy ra!');
        }
        cancelModal.hide();
      });
    }
  });
</script>